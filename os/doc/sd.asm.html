<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>sd.asm | ZI-28 Documentation</title>
	<link rel="stylesheet" href="styles.css" />
</head>

<body>
	<h1>ZI-28 Documentation</h1>
	<a href="index.html">&lt Back to index</a>

	<h2>File: sd.asm</h2>

	<div>
		<p>SD-card driver</p>
<p>Based on this design: <a href="http://www.ecstaticlyrics.com/electronics/SPI/fast_z80_interface.html" class="uri">http://www.ecstaticlyrics.com/electronics/SPI/fast_z80_interface.html</a></p>
<p>Port 0 is the transfer buffer.<br />
A write to port 1 transfers a byte between the buffer and the SD-card.<br />
Writing to port 2 enables the SD-card, writing to port 3 disabled it.</p>
	</div>

		<div class="routines">
		<h3>Routines</h3>
					<div class="menuentry">
			<div class="menutitle">
				<a href=#sd_init>sd_init</a>
			</div>
			<div class="menudesc">
				<p>Initialises the SD-card</p>
			</div>
		</div>
							<div class="menuentry">
			<div class="menutitle">
				<a href=#sd_read>sd_read</a>
			</div>
			<div class="menudesc">
				<p>Read from a SD-card</p>
			</div>
		</div>
							<div class="menuentry">
			<div class="menutitle">
				<a href=#sd_readBlock>sd_readBlock</a>
			</div>
			<div class="menudesc">
				<p>Read a block from a SD-card</p>
			</div>
		</div>
							<div class="menuentry">
			<div class="menutitle">
				<a href=#sd_write>sd_write</a>
			</div>
			<div class="menudesc">
				<dl>
<dt>Input:</dt>
<dd>ix - file entry addr
</dd>
<dd>(de) - buffer
</dd>
<dd>bc - count
</dd>
</dl>
			</div>
		</div>
							<div class="menuentry">
			<div class="menutitle">
				<a href=#sd_sendCmd>sd_sendCmd</a>
			</div>
			<div class="menudesc">
				<p>Send a command to the SD-card</p>
			</div>
		</div>
							<div class="menuentry">
			<div class="menutitle">
				<a href=#sd_getResponse>sd_getResponse</a>
			</div>
			<div class="menudesc">
				<p>Look for a specific response from the SD-card</p>
			</div>
		</div>
							<div class="menuentry">
			<div class="menutitle">
				<a href=#sd_enable>sd_enable</a>
			</div>
			<div class="menudesc">
				<p>Set CS to low to enable the SD-card</p>
			</div>
		</div>
							<div class="menuentry">
			<div class="menutitle">
				<a href=#sd_disable>sd_disable</a>
			</div>
			<div class="menudesc">
				<p>Set CS to low to enable the SD-card</p>
			</div>
		</div>
							<div class="menuentry">
			<div class="menutitle">
				<a href=#sd_transferByte>sd_transferByte</a>
			</div>
			<div class="menudesc">
				<p>Transfer a byte between the buffer and the SD-card</p>
			</div>
		</div>
							<div class="menuentry">
			<div class="menutitle">
				<a href=#delay100>delay100</a>
			</div>
			<div class="menudesc">
				<p>Wait for approx. 100ms</p>
			</div>
		</div>
			
					<div id="sd_init" class="box">
			<div class="boxheader">
				<p>sd_init</p>
			</div>
			<div class="boxcontent">
				<p>Initialises the SD-card</p>
<dl>
<dt>Input:</dt>
<dd>ix - devfs entry address
</dd>
</dl>
			</div>
		</div>
							<div id="sd_read" class="box">
			<div class="boxheader">
				<p>sd_read</p>
			</div>
			<div class="boxcontent">
				<p>Read from a SD-card</p>
<dl>
<dt>Input:</dt>
<dd>ix - file entry addr
</dd>
<dd>(de) - buffer
</dd>
<dd>bc - count
</dd>
<dt>Output:</dt>
<dd>de - count
</dd>
<dd>a - errno
</dd>
</dl>
			</div>
		</div>
							<div id="sd_readBlock" class="box">
			<div class="boxheader">
				<p>sd_readBlock</p>
			</div>
			<div class="boxcontent">
				<p>Read a block from a SD-card</p>
<dl>
<dt>Input:</dt>
<dd>ix - file entry addr
</dd>
<dd>(de) - buffer
</dd>
<dd>(bc) - 32-bit block number
</dd>
<dt>Output:</dt>
<dd>de = count
</dd>
<dd>a - errno
</dd>
</dl>
			</div>
		</div>
							<div id="sd_write" class="box">
			<div class="boxheader">
				<p>sd_write</p>
			</div>
			<div class="boxcontent">
				<dl>
<dt>Input:</dt>
<dd>ix - file entry addr
</dd>
<dd>(de) - buffer
</dd>
<dd>bc - count
</dd>
<dt>Output:</dt>
<dd>de - count
</dd>
<dd>a - errno
</dd>
</dl>
			</div>
		</div>
							<div id="sd_sendCmd" class="box">
			<div class="boxheader">
				<p>sd_sendCmd</p>
			</div>
			<div class="boxcontent">
				<p>Send a command to the SD-card</p>
<dl>
<dt>Input:</dt>
<dd>a - Command index
</dd>
<dd>c - Base port address
</dd>
<dd>(hl) - 32-bit argument
</dd>
<dt>Output:</dt>
<dd>carry - timeout
</dd>
<dd>nc - no error
</dd>
<dt>Destroyed:</dt>
<dd>a, b
</dd>
</dl>
			</div>
		</div>
							<div id="sd_getResponse" class="box">
			<div class="boxheader">
				<p>sd_getResponse</p>
			</div>
			<div class="boxcontent">
				<p>Look for a specific response from the SD-card</p>
<dl>
<dt>Input:</dt>
<dd>e - expected response
</dd>
<dd>b - number of retries
</dd>
<dd>c - base port address
</dd>
<dt>Output:</dt>
<dd>carry - timeout
</dd>
<dd>nc - got correct response
</dd>
<dt>Destroyed:</dt>
<dd>a, b
</dd>
</dl>
			</div>
		</div>
							<div id="sd_enable" class="box">
			<div class="boxheader">
				<p>sd_enable</p>
			</div>
			<div class="boxcontent">
				<p>Set CS to low to enable the SD-card</p>
<dl>
<dt>Input:</dt>
<dd>c - base port address
</dd>
<dt>Destroyed:</dt>
<dd>none
</dd>
</dl>
			</div>
		</div>
							<div id="sd_disable" class="box">
			<div class="boxheader">
				<p>sd_disable</p>
			</div>
			<div class="boxcontent">
				<p>Set CS to low to enable the SD-card</p>
<dl>
<dt>Input:</dt>
<dd>c - base port address
</dd>
<dt>Destroyed:</dt>
<dd>none
</dd>
</dl>
			</div>
		</div>
							<div id="sd_transferByte" class="box">
			<div class="boxheader">
				<p>sd_transferByte</p>
			</div>
			<div class="boxcontent">
				<p>Transfer a byte between the buffer and the SD-card</p>
<dl>
<dt>Destroyed:</dt>
<dd>none
</dd>
</dl>
			</div>
		</div>
							<div id="delay100" class="box">
			<div class="boxheader">
				<p>delay100</p>
			</div>
			<div class="boxcontent">
				<p>Wait for approx. 100ms</p>
<dl>
<dt>Destroyed:</dt>
<dd>none
</dd>
</dl>
			</div>
		</div>
				</div>
	


<footer>
</footer>


</body>
</html>
