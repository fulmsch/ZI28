include ../config.mk

OUTPUT_DIRECTORY := .

#USE_MPM=1
ifdef USE_MPM
LIBLINKER = mpm -I$(Z80_OZFILES) -d -ns -nm -Mo
ASSEMBLER = mpm -I$(Z80_OZFILES)
CFLAGS = -mpm
else
LIBLINKER = $(EXEC_PREFIX)z80asm -d -I../include
ASSEMBLER = $(EXEC_PREFIX)z80asm
CFLAGS = -O3 -vn -Wn43  -c -preserve
endif

SRCDIR := src
CFILES := $(shell find $(SRCDIR) -mindepth 2 -iname "*.c")
ASMFILES := $(shell find $(SRCDIR) -mindepth 2 -iname "*.asm")
OBJFILES := $(CFILES:.c=.o) $(ASMFILES:.asm=.o)
LIBDIRS := $(shell find $(SRCDIR) -mindepth 1 -maxdepth 1 -type d)
LIBNAMES := $(notdir $(LIBDIRS))
LIBS := $(addprefix $(OUTPUT_DIRECTORY)/, $(addsuffix .lib, $(LIBNAMES)))

.PHONY: all clean distclean

all: $(LIBS)

define make-deps
$(OUTPUT_DIRECTORY)/$(strip $(1)).lib: $(filter $(SRCDIR)/$(strip $(1))/%, $(OBJFILES))
endef

$(foreach l, $(LIBNAMES), $(eval $(call make-deps,$l)))

$(OUTPUT_DIRECTORY)/%.lib:
	@echo ''
	@echo '--- Creating $@ ---'
	@TARGET=zi28 TYPE=z80 $(LIBLINKER) -DFORzi28 -DSTANDARDESCAPECHARS -x$@ $^
	@# Clean up zcc_opt.def
	@$(RM) $(sort $(addsuffix /zcc_opt.def, $(^D)))

%.o: %.c
	$(ZCC) +zi28 $(CFLAGS) -o $@  $<

%.o: %.asm
	$(ZCC) +zi28 $(CFLAGS) -o $@  $<

clean: # Remove intermediate files
	@$(RM) $(shell find . -iname "*.o" -or -name "zcc_opt.def" -or -name "zcc_proj.lst")

distclean: clean # Remove all files generated by make
	@-$(RM) *.lib
